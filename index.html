<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Camgrid &middot; Prototype</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/fullcalendar/1.5.4/fullcalendar.css"/>
    <link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/fullcalendar/1.5.4/fullcalendar.print.css" media="print" />

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//netdna.bootstrapcdn.com/html5shiv/3.6.1/html5shiv.js"></script>
    <![endif]-->

    <!-- Le unavoidable scripts -->
    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
    <!-- Bootstrap -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="../assets/ico/favicon.png">

    <style type="text/css">
      #streams img {
        float: left;
        height: 240px;
      }
    </style>
  </head>

  <body>

    <div class="container">

      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li class="active"><a href="/">Home</a></li>
          <li><a href="?login">Login</a></li>
          <li><a href="?help">Aide</a></li>
        </ul>
        <h2>
          Camgrid
        </h2>
      </div>

      <hr>

      <form action="#">
        <div class="input-append"> 
          <input type="text" name="url" class="span8" placeholder="Stream URL, eg. http://mywebcam/example.com:8080/stream.mjpg" value="http://172.22.22.109:8081/?action=stream">
          <button class="btn">Add</button>
        </div>
        <a class="action-remove-streams" href="#">Remove all streams</a>
      </form>
      <div id="streams" class="gridly">
      </div>

    </div>

    <script>
      function list() {
          return $('#streams img').map(function() {
              return $(this).attr('src');
          }).get();
      }
      function add(url) {
          // Prevents adding duplicate URLs
          var urls = list();
          if ($(urls).filter([url]).length) {
              $.bootstrapGrowl("This stream has already been added", {
                  type: 'info',
                  align: 'center'
              });
              return;
          }
          // Creates and appends <img> tag
          console.debug('creating DOM');
          var img = $('<img/>', {
              src: url,
              load: function() { 
                  console.debug('image loaded:', this.src)
                  // Relayouts gridly
                  // TODO: Refactor: these is the "layout" object that handles
                  // high-level layout related stuff (such as sizing, dragging, etc.)
                  $('.gridly').gridly('layout');
                  // Saves url to streams list cookie
                  // TODO: Refactor: there is the "session" object that handles
                  // view parameters storage and retrieval
                  console.debug('adding URL to streams list');
                  var sep = ' ';
                  var streams = $.cookie('streams');
                  streams = streams ? streams.split(sep) : [];
                  streams.unshift(url);
                  console.debug('streams list updated to', streams);
                  $.cookie('streams', streams.join(sep), {expires:365});
              },
              error: function() {
                  console.error('failed loading', this.src);
                  // Notifies user
                  $.bootstrapGrowl("We cannot load this stream", {
                      type: 'error',
                      align: 'center',
                      width: 'auto'
                  });
                  // Removes created DOM element
                  $(this).remove();
              }
          });
          $('#streams').append(img);
      }
      function remove(url) {
          console.debug('removing', url);
          // Removes from stream list cookie
          var streams = $(list()).map(function(i, u) {
              if (u !== url) return u;
          }).get();
          console.debug('remaining streams', streams);
          $.cookie('streams', streams.join(' '));
          // Removes img tag
          $('#streams img[src="'+url+'"]').remove();
      }
      $(document).ready(function() {
          // Autofocuses on form  input
          $('input:first').focus();

          // Handles 'add stream' action
          $('form').on('submit', function() {
              var url = $('input', this).val();
              add(url);
              return false;
          });
          // Handles remove all streams
          $('.action-remove-streams').on('click', function() {
              $.each(list(), function(i, url) {
                  remove(url);
              });
          });

          // Restores streams list (from cookie)
          console.debug('restoring streams from cookie');
          var streams = $.cookie('streams');
          streams = streams ? streams.split(' ') : [];
          $.removeCookie('streams'); // Prevents add() duplicate detection
          console.debug('restoring urls', streams);
          $.each(streams, function(i, url) {
              add(url);
          });

          // Setups gridly on stream images list
          $('#streams').gridly({
              //base: 60, // px 
              gutter: 10, // px
              //columns: 12
          });
      });
    </script>

    <!-- BootstrapGrowl -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-growl/1.0.0/jquery.bootstrap-growl.min.js" type="text/javascript"></script>
    <!-- Cookie -->
    <script src="//cdn.jsdelivr.net/jquery.cookie/1.3.1/jquery.cookie.js" type="text/javascript"></script>
    <!-- Gridly -->
    <style type="text/css">
      .gridly {
        position: relative;
      }
    </style>
    <script src="http://ksylvest.github.io/jquery-gridly/javascripts/jquery.gridly.js" type="text/javascript"></script>
    <link href="http://ksylvest.github.io/jquery-gridly/stylesheets/jquery.gridly.css" rel="stylesheet" type="text/css" />
  <body>
</html>
